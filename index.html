<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Hoti Family Database</title>

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px; }
h1,h2 { text-align:center; }
.common { background:#fff; padding:15px; border-radius:10px; margin-bottom:20px; }
table { width:100%; border-collapse:collapse; background:#fff; margin-bottom:20px; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#007bff; color:white; font-size:13px; }
input, select { width:100%; padding:5px; }
button {
  padding:10px 15px; font-size:15px; margin:5px;
  background:#007bff; color:white; border:none; border-radius:6px;
  cursor:pointer;
}
button:hover { background:#0056b3; }
</style>
</head>

<body>

<h1>Hoti Family Details</h1>

<form method="POST"
      action="https://script.google.com/macros/s/AKfycbxPePb0UfSWIL-nPizo8JBL3gi4ZTh4bEtAhVy3-siViBZI4O_aaACvwoKJX9r1jTcIRQ/exec"
      onsubmit="prepareSubmission(); exportExcel();">

<div class="common">
  <b>Hoti Name:</b><br>
  <input id="hotiName" name="hotiName" oninput="handleHotiChange()" required><br><br>
  <b>Hoti No:</b><br>
  <input id="hotiNo" name="hotiNo" oninput="handleHotiChange()" required>
</div>

<h2>Main Family Members</h2>
<table>
<tr>
  <th>Sr No</th>
  <th>Hoti Name</th>
  <th>Hoti No</th>
  <th>Name</th>
  <th>DOB</th>
  <th>Age</th>
  <th>Education</th>
  <th>Mobile</th>
  <th>Station</th>
  <th>Employment</th>
  <th>Business</th>
  <th>Relation</th>
  <th>Married</th>
  <th>Origin Village of Spouse</th>
</tr>
<tbody id="familyBody"></tbody>
</table>

<button type="button" onclick="addFamilyRow()">Add Family Member</button>

<h2>Married Daughters / Suvani</h2>
<table>
<tr>
  <th>Sr No</th>
  <th>Hoti Name</th>
  <th>Hoti No</th>
  <th>Name</th>
  <th>DOB</th>
  <th>Age</th>
  <th>Education</th>
  <th>Mobile</th>
  <th>Station</th>
  <th>Occupation</th>
  <th>Relation</th>
  <th>Married</th>
  <th>Origin Village of Spouse</th>
</tr>
<tbody id="suvaniBody"></tbody>
</table>

<button type="button" onclick="addSuvaniRow()">Add Suvani</button>

<input type="hidden" name="payload" id="payload">

<br><br>
<button type="submit">Submit & Save (Database)</button>

</form>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
let famSr = 0;
let autoCreated = false;

function handleHotiChange() {
  if (!autoCreated && hotiName.value && hotiNo.value) {
    addFamilyRow();
    autoCreated = true;
  }
  updateHotiInRows();
  updateSuvaniSrNo();
}

function updateHotiInRows() {
  document.querySelectorAll("#familyBody tr").forEach(r=>{
    r.cells[1].children[0].value = hotiName.value;
    r.cells[2].children[0].value = hotiNo.value;
  });
  document.querySelectorAll("#suvaniBody tr").forEach(r=>{
    r.cells[1].children[0].value = hotiName.value;
    r.cells[2].children[0].value = hotiNo.value;
  });
}

function calcAge(dob, age) {
  if (!dob.value) return;
  const d = new Date(dob.value);
  const t = new Date();
  let years = t.getFullYear() - d.getFullYear();
  let months = t.getMonth() - d.getMonth();
  if (t.getDate() < d.getDate()) months--;
  if (months < 0) { years--; months += 12; }
  age.value = years <= 0 ? months + " months" : years;
}

function numericOnly(el) {
  el.value = el.value.replace(/[^0-9]/g,'');
}

function addFamilyRow() {
  famSr++;
  familyBody.insertRow().innerHTML = `
<td>${famSr}</td>
<td><input readonly></td>
<td><input readonly></td>
<td><input></td>
<td><input type="date" onchange="calcAge(this,this.parentElement.nextElementSibling.children[0])"></td>
<td><input readonly></td>
<td><input></td>
<td><input oninput="numericOnly(this)"></td>
<td><input></td>
<td>
<select>
<option></option>
<option>Self Employed</option>
<option>Employed</option>
<option>Housewife</option>
<option>Student</option>
<option>Not Applicable</option>
</select>
</td>
<td><input></td>
<td><input></td>
<td>
<select><option></option><option>Yes</option><option>No</option></select>
</td>
<td><input></td>`;
  updateHotiInRows();
  updateSuvaniSrNo();
}

function addSuvaniRow() {
  suvaniBody.insertRow().innerHTML = `
<td></td>
<td><input readonly></td>
<td><input readonly></td>
<td><input></td>
<td><input type="date" onchange="calcAge(this,this.parentElement.nextElementSibling.children[0])"></td>
<td><input readonly></td>
<td><input></td>
<td><input oninput="numericOnly(this)"></td>
<td><input></td>
<td><input></td>
<td>Suvani</td>
<td>
<select><option></option><option>Yes</option><option>No</option></select>
</td>
<td><input></td>`;
  updateHotiInRows();
  updateSuvaniSrNo();
}

function updateSuvaniSrNo() {
  document.querySelectorAll("#suvaniBody tr").forEach((r,i)=>{
    r.cells[0].innerText = famSr + i + 1;
  });
}

function prepareSubmission() {
  const rows = [];

  document.querySelectorAll("#familyBody tr").forEach(r=>{
    rows.push({
      type:"Family",
      name:r.cells[3].children[0].value,
      dob:r.cells[4].children[0].value,
      age:r.cells[5].children[0].value,
      education:r.cells[6].children[0].value,
      mobile:r.cells[7].children[0].value,
      station:r.cells[8].children[0].value,
      employment:r.cells[9].children[0].value,
      business:r.cells[10].children[0].value,
      relation:r.cells[11].children[0].value,
      married:r.cells[12].children[0].value,
      spouse:r.cells[13].children[0].value
    });
  });

  document.querySelectorAll("#suvaniBody tr").forEach(r=>{
    rows.push({
      type:"Suvani",
      name:r.cells[3].children[0].value,
      dob:r.cells[4].children[0].value,
      age:r.cells[5].children[0].value,
      education:r.cells[6].children[0].value,
      mobile:r.cells[7].children[0].value,
      station:r.cells[8].children[0].value,
      employment:r.cells[9].children[0].value,
      relation:"Suvani",
      married:r.cells[11].children[0].value,
      spouse:r.cells[12].children[0].value
    });
  });

  document.getElementById("payload").value = JSON.stringify(rows);
}

function exportExcel() {
  const data = [];

  data.push([
    "Sr No","Hoti Name","Hoti No","Name","DOB","Age","Education",
    "Mobile","Station","Employment","Business","Relation","Married","Origin Village of Spouse"
  ]);

  document.querySelectorAll("#familyBody tr").forEach(r=>{
    data.push([
      r.cells[0].innerText,
      r.cells[1].children[0].value,
      r.cells[2].children[0].value,
      r.cells[3].children[0].value,
      r.cells[4].children[0].value,
      r.cells[5].children[0].value,
      r.cells[6].children[0].value,
      r.cells[7].children[0].value,
      r.cells[8].children[0].value,
      r.cells[9].children[0].value,
      r.cells[10].children[0].value,
      r.cells[11].children[0].value,
      r.cells[12].children[0].value,
      r.cells[13].children[0].value
    ]);
  });

  document.querySelectorAll("#suvaniBody tr").forEach(r=>{
    data.push([
      r.cells[0].innerText,
      r.cells[1].children[0].value,
      r.cells[2].children[0].value,
      r.cells[3].children[0].value,
      r.cells[4].children[0].value,
      r.cells[5].children[0].value,
      r.cells[6].children[0].value,
      r.cells[7].children[0].value,
      r.cells[8].children[0].value,
      r.cells[9].children[0].value,
      "",
      r.cells[10].innerText,
      r.cells[11].children[0].value,
      r.cells[12].children[0].value
    ]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);
  ws["!cols"] = Array(14).fill({ wch: 20 });

  XLSX.utils.book_append_sheet(wb, ws, "Hoti Family");
  XLSX.writeFile(wb, (hotiNo.value || "Hoti_Family") + ".xlsx");
}
</script>

</body>
</html>
